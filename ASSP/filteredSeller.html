<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/kursor@0.0.14/dist/kursor.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/kursor/dist/kursor.css" />
    <link rel="icon" href="images/logo.png" type="image/gif" sizes="16x16" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/swiper@7/swiper-bundle.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <title>Document</title>

    <style>
      /* Modal */
      .modal {
        display: block;
        position: fixed;
        z-index: 1000;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 80%; /* Adjust width as needed */
        max-width: 600px; /* Adjust max-width as needed */
        background-color: #fff; /* Change background color to white */
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      /* Modal Content */
      .modal-content h2 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      .modal-content button {
        display: block;
        width: 100%;
        padding: 10px 0;
        margin-bottom: 10px;
        text-align: center;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .modal-content button:last-child {
        margin-bottom: 0;
      }

      .modal-content button:hover {
        background-color: #0056b3;
      }
      /* Close Button */
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      /* Styling for Orange Money content */
      .orange-money-text {
        color: #333; /* Change text color as needed */
        font-size: 16px; /* Change font size as needed */
        line-height: 1.5; /* Change line height as needed */
      }
      #orange-money-content {
        display: none; /* Start by hiding the content */
        /* Add other styling properties as needed */
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <a href="#" class="logo">
        <img
          src="./Images/new.png"
          alt="ASAP"
          style="width: 120px; height: 50px"
        />
      </a>
      <nav class="navbar">
        <a href="./index.html">Home</a>
        <a href="./Product.html">Services</a>
        <a href="./Login And Registration.html">Login</a>
        <a href="./BecomeSeller.html">Become a Professional?</a>
      </nav>
      <div class="icons">
        <div class="fas fa-bars" id="menu-btn"></div>
        <div class="fas fa-search" id="search-btn"></div>
        <div class="fas fa-user" id="login-btn"></div>
        <div class="fas fa-sign-out-alt" id="logout-btn"></div>
      </div>
      <script>
        // Add event listener to the logout button
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            // Fetch request to logout endpoint
            fetch("https://asap-new-backend.vercel.app/logout", {
              method: "POST",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"), // Assuming token is stored in localStorage
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Failed to logout");
                }
                // Clear token from localStorage upon successful logout
                localStorage.removeItem("token");
                // localStorage.removeItem("userId");
                localStorage.removeItem("userType");
                if (localStorage.payStatus) {
                  localStorage.removeItem("payStatus");
                }

                // Clear user ID from localStorage or memory
                localStorage.removeItem("userId"); // Assuming user ID is stored in localStorage
                // Log a message in the console indicating successful logout
                alert("Your account is Logged out. Thank You!");
                // Redirect to login page or perform other actions as needed
                window.location.href = "./index.html"; // Redirect to login page
              })
              .catch((error) => {
                console.error("Error logging out:", error);
                // Handle error accordingly
              });
          });
      </script>
      <form action="" class="search-form">
        <input type="search" id="search-box" placeholder="Search here..." />
        <label for="search-box" class="fas fa-search"></label>
      </form>
    </header>

    <section class="products" id="products">
      <h1 class="heading" style="margin-top: 100px;">Service <span>Providers</span></h1>

      <div id="sellerDataContainer"></div>

      <section class="overlay hidden" id="aboutMeOverlay">
        <div class="modal" style="padding: 50px 20px;">
          <p style="position: absolute; top: 0; right: 0; margin: 10px; font-size: 18px;font-weight: bolder;cursor: pointer;padding: 2px;" id="closeBtn">X</p>
          <h2 style="font-size: 19px;">About Me :</h2>
          <p style="font-size: 15px;" id="userDescription"></p>
        </div>
      </section>

    </section>

    <div id="orange-money-content" style="display: none">
      <p>
        To make a merchandise payment, please dial <b>#150*47#</b> then type the
        merchandise code 803233. You will then see the name of the enterprise
        ESA Sarl. You will be able to enter the amount to pay and confirm the
        payment.
      </p>
    </div>

    <!-- Footer Section Start -->
    <section class="footer">
      <div class="box-container">
        <div class="box">
          <!-- <h3>As Soon As Possible </h3> -->
          <a href="#" class="logo">
            <img
              src="./Images/new.png"
              alt="ASAP"
              style="width: 120px; height: 50px"
            />
          </a>
          <p>Get Quick and Quality Services Tailored Just For You!</p>
          <div class="share">
            <a href="#" class="fab fa-facebook-f"></a>
            <a href="#" class="fab fa-twitter"></a>
            <a href="#" class="fab fa-instagram"></a>
            <a href="#" class="fab fa-linkedin"></a>
          </div>
          <div>
            <!-- <a style="color: rgb(17, 1, 1); border-color: white;" href="./admin-panel/index.html" class="btn">Administrator</a> -->
          </div>
        </div>
        <div class="box">
          <h3>contact info</h3>
          <a href="#" class="links">
            <i class="fas fa-phone"></i> +13016060756
          </a>
          <a href="#" class="links">
            <i class="fas fa-phone"></i> +13016060756
          </a>
          <a href="#" class="links">
            <i class="fas fa-envelope"></i> inquiriesesa@gmail.com
          </a>
          <a href="#" class="links">
            <i class="fas fa-map-marker-alt"></i> Maryland, USA
          </a>
        </div>
        <div class="box">
          <h3>quick links</h3>
          <a href="#" class="links">
            <i class="fas fa-arrow-right"></i> Home
          </a>
          <a href="#" class="links">
            <i class="fas fa-arrow-right"></i> Features
          </a>
          <a href="#" class="links">
            <i class="fas fa-arrow-right"></i> Services
          </a>
          <a href="./Login And Registration.html" class="links">
            <i class="fas fa-arrow-right"></i> Sign up to find Services
          </a>
        </div>
        <div class="box">
          <h3>Explore Services</h3>
          <a
            href="https://getasapservice.com/Product.html?categoryId=655d9cebc4dfadac49f74de9"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Education
          </a>
          <a
            href="https://getasapservice.com/Product.html?categoryId=655d9d34c4dfadac49f74def"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Administrative</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=655d9dcbc4dfadac49f74df3"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> HouseHold</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=655d9e11c4dfadac49f74df6"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> HealthCare</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=656242cc962dfa610e66c992"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Construction</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=65c1244139044b23990949a7"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Attorney</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=65c12892bf65e74a325705a6"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Human Resource Consulting</a
          >
          <a
            href="https://getasapservice.com/Product.html?categoryId=65c12ab5577c446874171e3e"
            class="links"
          >
            <i class="fas fa-arrow-right"></i> Accounting and finance</a
          >
        </div>
      </div>
      <div class="credit"><span></span> all rights reserved</div>
    </section>

    <script>
      let headers = {};
      let sellerData = "";

      document.addEventListener("DOMContentLoaded", async function () {
        // Extracting query parameters from the URL
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        let city = urlParams.get("city");
        let category = urlParams.get("category");
        let zipCode = urlParams.get("zipCode");
        let product = urlParams.get("product");
        // console.log(product);
        // Setting up headers for the request
        headers = {
          city: city,
          category: category,
          zipcode: zipCode,
          product: product,
        };
        const userId = localStorage.getItem("userId");

        // console.log(category);
        // console.log(headers);
        // console.log(headers);

        try {
          // Fetching data from the API using GET method and headers
          const response = await fetch(
            "https://asap-new-backend.vercel.app/getFilteredSellers",
            {
              method: "GET",
              headers: headers,
            }
          );

          if (!response.ok) {
            console.log("Error filtering sellers");
            return;
          }

          // Parsing the response data as JSON
          const data = await response.json();

          // Storing the fetched data into sellerData variable
          sellerData = data.data;
          const sellerDataContainer = document.getElementById(
            "sellerDataContainer"
          );

          if (sellerData.length === 0) {
            const noResultMessage = document.createElement("div");
            noResultMessage.textContent = "No result found";
            noResultMessage.classList.add("no-result-message"); // Add the CSS class
            sellerDataContainer.appendChild(noResultMessage);
          } else {
            sellerData.forEach((seller) => {
              const sellerElement = document.createElement("div");
              sellerElement.classList.add("sellerItem");
              
              // Create a div for seller image
              const sellerImageDiv = document.createElement("div");
              sellerImageDiv.classList.add("sellerImage");
              // Create an img tag for the seller image
              const sellerImage = document.createElement("img");
              sellerImage.src = seller.image?seller.image:"https://www.nicepng.com/png/detail/128-1280406_view-user-icon-png-user-circle-icon-png.png"; // Set the src attribute with the seller's image source

              // Append the image to the seller image div
              sellerImageDiv.appendChild(sellerImage);
              sellerElement.appendChild(sellerImageDiv)

              const sellerDetailsDiv = document.createElement("div"); // Create a div for seller details
              sellerDetailsDiv.classList.add("sellerDetails"); // Add a class for styling

              const sellerDetails = `
                  <p><b>Category</b>: ${seller.category.Title}</p>
                  <p><b>Service</b>: ${seller.product.name}</p>
                  <div><span><b>City</b>: ${seller.city}</span>
                  <span><b>Country</b>: ${seller.country}</span>  </div>
                  
                  <p><b>Experience</b>:${seller.experience}</p>
                  <p><b>Zip Code</b>: ${seller.zipCode}</p>
                `;
              sellerDetailsDiv.innerHTML = sellerDetails;
              sellerElement.appendChild(sellerDetailsDiv);

              const bookNowButton = document.createElement("button");
              bookNowButton.textContent = "Book Now";
              bookNowButton.classList.add("btn");

              // about me button
              const aboutMeButton = document.createElement("button")
              aboutMeButton.textContent = "About Me"
              aboutMeButton.classList.add("btn")
              aboutMeButton.addEventListener("click" , function(){
                const overlay = document.getElementById("aboutMeOverlay")
                const userDescription = document.getElementById("userDescription")
                userDescription.innerText = seller.details
                overlay.classList.remove("hidden")
              })
              sellerElement.appendChild(aboutMeButton)
              const closeBtn = document.getElementById("closeBtn")
              closeBtn.addEventListener('click',function() {
                const overlay = document.getElementById("aboutMeOverlay")
                overlay.classList.add("hidden")
              })



              // BUTTON EVENT HANDLER
              bookNowButton.addEventListener("click", async () => {
                const paystatus = localStorage.getItem("payStatus");
                // console.log(JSON.stringify(paystatus));

                if (paystatus === "true") {
                  checkExpire();
                  // window.location.href=`/ASSP/card.html?productId=${headers.product}&zipCode=${headers.zipcode || ''}&city=${headers.city || ''}`
                  // window.location.href="ASSP/card.html"
                } else {
                  // Create modal
                  const modal = document.createElement("div");
                  modal.classList.add("modal");

                  // Modal content
                  const modalContent = document.createElement("div");
                  modalContent.classList.add("modal-content");
                  const closeButton = document.createElement("span");
                  closeButton.innerHTML = "&times;"; // HTML entity for cross icon
                  closeButton.classList.add("close");
                  closeButton.addEventListener("click", () => {
                    modal.style.display = "none";
                  });
                  modalContent.appendChild(closeButton);
                  // Payment gateway selection
                  const heading = document.createElement("h2");
                  heading.textContent = "Choose Payment Gateway";
                  modalContent.appendChild(heading);

                  // Stripe button
                  const stripeButton = document.createElement("button");
                  stripeButton.textContent = "Card Payment";
                  stripeButton.classList.add("btn");
                  stripeButton.addEventListener("click", async () => {
                    // Call Stripe checkout API
                    await callStripeCheckoutAPI();
                    // Close modal after processing
                    modal.style.display = "none";
                  });
                  modalContent.appendChild(stripeButton);

                  // Orange Money button
                  const orangeMoneyButton = document.createElement("button");
                  orangeMoneyButton.textContent = "Orange Money";
                  orangeMoneyButton.classList.add("btn");

                  // Add event listener for Orange Money button
                  // Add event listener to the orangeMoneyButton
                  // Add event listener to the orangeMoneyButton
                  // Add event listener to the orangeMoneyButton
                  // Add event listener to the orangeMoneyButton
                  // Add event listener to the Orange Money button
                  const createOrangeMoneyContent = () => {
                    // Create a div element for the Orange Money content
                    const orangeMoneyContent = document.createElement("div");
                    orangeMoneyContent.classList.add("orange-money-text");
                    // orangeMoneyContent.innerHTML = 'To make a merchandise payment, please dial <b>#150*47#</b> then type the merchandise code 803233. You will then see the name of the enterprise ESA Sarl. You will be able to enter the amount to pay and confirm the payment. After the payment send the Screen Shot to ';
                    orangeMoneyContent.innerHTML =
                      "To make a merchandise payment, please dial <b>#150*47#</b> then type the merchandise code 803233. You will then see the name of the enterprise ESA Sarl. You will be able to enter the amount to pay and confirm the payment. After the payment send the Screen Shot to <b>inquiriesesa@gmail.com</b>.";

                    const sendRequestButton = document.createElement("button");
                    sendRequestButton.textContent = "Send Request";
                    sendRequestButton.classList.add("btn");

                    // Attach event listener to the "Send Request" button
                    sendRequestButton.addEventListener("click", () => {
                      // Define the data you want to send in the request body
                      const requestData = {
                        userId: userId, // Assuming userId is defined somewhere in your code
                      };

                      // Make the HTTP POST request to the API endpoint
                      fetch("https://asap-new-backend.vercel.app/postRequest", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                      })
                        .then((response) => {
                          if (!response.ok) {
                            throw new Error("Network response was not ok");
                          }
                          return response.json();
                        })
                        .then((data) => {
                          // Process the response data
                          // console.log(data);
                          // Assuming you want to display some feedback to the user
                          alert("Your request has been sent"); // or do something else with the data
                        })
                        .catch((error) => {
                          // Handle errors
                          // console.error('There was a problem with the fetch operation:', error);
                          // Assuming you want to display an error message to the user
                          if (!userId) {
                            alert(
                              "An error occurred while processing your request. Please Login First."
                            );
                          } else {
                            alert("Your Request is already Pending");
                          }
                        });
                    });

                    // Append the "Send Request" button to the modal content
                    modalContent.appendChild(sendRequestButton);
                    return orangeMoneyContent;
                  };

                  // Add event listener for Orange Money button
                  // Variable to keep track of Orange Money content visibility
                  let orangeMoneyContentVisible = false;

                  // Add event listener for Orange Money button
                  orangeMoneyButton.addEventListener("click", () => {
                    if (!orangeMoneyContentVisible) {
                      // Create Orange Money content and append it to the modal content
                      const orangeMoneyContent = createOrangeMoneyContent();
                      modalContent.appendChild(orangeMoneyContent);
                      orangeMoneyContentVisible = true;
                    } else {
                      // Toggle the visibility of the content
                      const existingOrangeMoneyContent =
                        modalContent.querySelector("#orange-money-content");
                      existingOrangeMoneyContent.style.display =
                        existingOrangeMoneyContent.style.display === "none"
                          ? "block"
                          : "none";
                    }
                  });

                  modalContent.appendChild(orangeMoneyButton);

                  // Close button
                  // Close button

                  // Append modal content to modal
                  modal.appendChild(modalContent);

                  // Display modal
                  document.body.appendChild(modal);
                  // Add styling for modal and modal content (CSS)
                  // Adjust CSS to fit your styling needs
                  // Example:
                }
              });

              sellerElement.appendChild(bookNowButton);
              sellerDataContainer.appendChild(sellerElement);
            });
          }
        } catch (error) {
          // Handling errors if any
          console.log("There was an error with the request:", error);
        }
      });

      const callStripeCheckoutAPI = async () => {
        // Retrieve productId from the product data
        const productId = headers.product;
        const zipCode = headers.zipcode;
        const city = headers.city;
        const userId = localStorage.getItem("userId");
        if (!userId) {
          // Redirect to login page if userId is missing
          window.location.href = "./Login And Registration.html";
          return;
        } // Redirect to card.html with the productId in the URL
        const checkoutSessionResponse = await fetch(
          "https://asap-new-backend.vercel.app/create-checkout-session",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: userId,
              productId: productId, // Include productId
              zipCode: zipCode, // Include productId
              city: city, // Include productId
            }),
          }
        );
        const checkoutSessionData = await checkoutSessionResponse.json();
        const stripe = Stripe(
          "pk_live_51OOyuMH9HQ2Ek1tPqeD7UxC2prsw4CcFvR7EGm0peMViAi2daLpliXTbDpGP5FPiysdNKL6If9glg5B1wGV4EymV00zFk8LWQ7"
        );

        // Redirect to the Stripe Checkout page
        const { error } = await stripe.redirectToCheckout({
          sessionId: checkoutSessionData.sessionId,
        });
        if (error) {
          console.error("An error occurred during Stripe checkout:", error);
        }
      };

      async function checkExpire() {
        const userId = localStorage.getItem("userId");

        try {
          const res = await fetch(
            `https://asap-new-backend.vercel.app/checkExpired/${userId}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          if (res.ok) {
            const data = await res.json();
            if (data.expired) {
              alert("Your Payment has expired");
              if (localStorage.payStatus) {
                localStorage.removeItem("payStatus");
              }
            } else {
              window.location.href = `card.html?productId=${
                headers.product
              }&zipCode=${headers.zipcode || ""}&city=${headers.city || ""}`;
              // window.location.href="ASSP/card.html"
              // console.log("Your are good to go");
            }
            // console.log(data);

            // console.log("expire",res.expire);
          }

          // console.log(res);
        } catch (error) {
          console.log(error);
        }
      }

      // console.log("hello");
      // console.log("sellerData");

      new kursor({
        type: 1,
      });

      // console.log(headers.productId);
      window.onload = function () {
        // localStorage
      };
    </script>
  </body>
</html>
